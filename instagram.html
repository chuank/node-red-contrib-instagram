<!--
  Copyright 2014 IBM Corp.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->


<script type="text/x-red" data-template-name="instagram-credentials">
    <div id="node-config-instagram-app-keys">
        <div class="form-row">
            <p style="margin-top: 10px;"><b>1.</b> <span data-i18n="instagram.label.create"></span> <a href="https://developers.facebook.com/docs/instagram-basic-display-api/getting-started" target="_blank" style="text-decoration:underline;">developers.facebook.com</a></p>
        </div>
        <div class="form-tips" id="node-config-tooltip">
            #
        </div>
        <div class="form-row">
            <p style="margin-top: 10px;"><b>2.</b> <span data-i18n="instagram.label.copy"></span>:</p>
        </div>
        <div class="form-row">
          <label for="node-config-input-appID"><i class="fa fa-user"></i> <span data-i18n="instagram.label.appid"></span></label>
          <input type="text" id="node-config-input-appID">
        </div>
        <div class="form-row" id="node-config-appSecret">
            <label for="node-config-input-appSecret"><i class="fa fa-lock"></i> <span data-i18n="instagram.label.appsecret"></span></label>
            <input type="password" id="node-config-input-appSecret">
        </div>
        <div class="form-row" id="node-config-redirectURI">
            <label for="node-config-input-redirectURI"><i class="fa fa-user"></i><span data-i18n="instagram.label.redirecturi"></span></label>
            <input type="text" id="node-config-input-redirectURI">
        </div>
        <div class="form-row">
           <label>&nbsp;</label>
           <a class="btn" id="node-config-start-auth" href="#" target="_blank"><span data-i18n="instagram.label.authenticate"></span></a>
        </div>
    </div>
    <div id="node-config-instagram-user">
        <div class="form-row">
            <label><i class="fa fa-user"></i> <span data-i18n="instagram.label.instagramuser"></span></label><span id="node-config-instagram-user_id" class="input-xlarge uneditable-input"></span>
        </div>
        <input type="hidden" id="node-config-input-user_id">
    </div>
</script>

<script type="text/x-red" data-template-name="instagram">
    <div class="form-row">
        <label for="node-input-instagram"><i class="fa fa-user"></i> <span data-i18n="instagram.label.user"></span></label>
        <input type="text" id="node-input-instagram">
    </div>
    <div class="form-row">
        <label for="node-input-outputType"><i class="icon-search"></i> <span data-i18n="instagram.label.output"></span></label>
        <select type="text" id="node-input-outputType" style="display: inline-block; vertical-align: middle; width:60%;">
            <option value="buffer" data-i18n="instagram.label.buffer"></option>
            <option value="link" data-i18n="instagram.label.url"></option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-interval"><i class="fa fa-repeat"></i> <span data-i18n="instagram.label.pollinterval"></span></label>
        <input type="text" id="node-input-interval" style="width:10%;">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="instagram.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]instagram.placeholder.name">
    </div>
</script>

<script type="text/x-red" data-help-name="instagram">
    <p>Get photos from Instagram.</p>
    <p>More information coming.</p>
    <p>Videos are currently not supported and are ignored.</p>
</script>

<script type="text/javascript">
(function() {

	RED.nodes.registerType("instagram-credentials",{
		category: "config",
		defaults: {
			user_id: {value: ""}
		},
		credentials: {
			user_id: {type:"text"},         // Instagram user ID (numerical)
			username: {type:"text"},        // Basic Display API username
			app_id: {type:"text"},          // Basic Display API app_id
			app_secret: {type:"password"},  // Basic Display API app_secret
			redirectURI: {type:"text"},
			access_token: {type:"password"},
			expires_in: {type:"number"}       // expiry date (in seconds) of long-lived access token
		},
		label: function() {
			return this.user_id;           // TODO: change to retrieve username once authenticated
		},
		exportable: false,
		oneditprepare: function() {
			var node_id = this.id;
			var pathname = document.location.pathname;
			if (pathname.slice(-1) != "/") {
				pathname += "/";
			}
			var constructedURI = location.protocol + "//" + location.hostname + (location.port ? ":"+location.port : "") + pathname + "instagram-credentials/auth/callback";
			var tip = this._("instagram.tip.redirect", {constructedURI: constructedURI});

			function updateInstagramAuthButton() {
				var v1 = $("#node-config-input-appID").val();
				var v2 = $("#node-config-input-appSecret").val();
				$("#node-config-start-auth").toggleClass("disabled",(v1.length === 0 || v2.length === 0));
			}
			$("#node-config-input-appID").on("change keydown paste input", updateInstagramAuthButton);
			$("#node-config-input-appSecret").on("change keydown paste input", updateInstagramAuthButton);

			function updateInstagramScreenName(sn) {
				$("#node-config-instagram-app-keys").hide();
				$("#node-config-instagram-user").show();
				$("#node-config-input-user_id").val(sn);
				$("#node-config-instagram-user_id").html(sn);
			}

			function pollInstagramCredentials() {
				$.getJSON("credentials/instagram-credentials/"+node_id,function(data) {
					if (data.user_id) {    // means authentication has been successful
						$("#node-config-dialog-ok").button("enable");
						updateInstagramScreenName(data.username);
						delete window.instagramConfigNodeIntervalId;
					} else {
						window.instagramConfigNodeIntervalId = window.setTimeout(pollInstagramCredentials,2000);
					}
				});
			}

			updateInstagramAuthButton();

			if (this.user_id) {
				updateInstagramScreenName(this.user_id);
			} else {
				$("#node-config-instagram-app-keys").show();
				$("#node-config-instagram-user").hide();
				$("#node-config-dialog-ok").button("disable");
			}

			function updateRedirectURI() {
				$("#node-config-tooltip").html(tip);
				$("#node-config-input-redirectURI").val(constructedURI);
				$("#node-config-input-redirectURI").hide();
				$("#node-config-redirectURI").hide();
			}

			updateRedirectURI();

			$("#node-config-start-auth").mousedown(function() {
				var appID = $("#node-config-input-appID").val();
				var appSecret = $("#node-config-input-appSecret").val();
				var redirectURI = $("#node-config-input-redirectURI").val();

				var query = "node_id=" + node_id + "&app_id=" + appID + "&app_secret=" + appSecret + "&redirect_uri=" + redirectURI;
				var url = "instagram-credentials/auth/?" + query;
				$(this).attr("href",url);
				window.instagramConfigNodeIntervalId = window.setTimeout(pollInstagramCredentials, 2000);
			});

			$("#node-config-start-auth").click(function(e) {
				var appID = $("#node-config-input-appID").val();
				var appSecret = $("#node-config-input-appSecret").val();
				var redirectURI = $("#node-config-input-redirectURI").val();
				if (appID === "" || appSecret === "" || redirectURI === "") {
					e.preventDefault();
				}
			});
		},
		oneditsave: function() {
			if (window.instagramConfigNodeIntervalId) {
				window.clearTimeout(window.instagramConfigNodeIntervalId);
				delete window.instagramConfigNodeIntervalId;
			}
		},
		oneditcancel: function() {
			if (window.instagramConfigNodeIntervalId) {
				window.clearTimeout(window.instagramConfigNodeIntervalId);
				delete window.instagramConfigNodeIntervalId;
			}
		}
	});
})();
</script>

<script type="text/javascript">
    RED.nodes.registerType("instagram",{
    	category: "social",
    	defaults: {
    		instagram: { type:"instagram-credentials", required: true },
    		inputType: { value:"photo"},
    		outputType: { value:"link" },
    		interval: { value:60 },
    		name: {value:""}
    	},
    	color:"#889FB3",
    	inputs:1,
    	outputs:2,
    	icon: "instagram.png",
    	label: function() {
    		return this.name||this._("instagram.label.instagram");
    	},
    	labelStyle: function() {
    		return this.name?"node_label_italic":"";
    	}
    });
</script>
